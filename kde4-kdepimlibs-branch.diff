Index: kimap/sessionthread.cpp
===================================================================
--- kimap/sessionthread.cpp	(.../tags/KDE/4.5.0/kdepimlibs)	(wersja 1165574)
+++ kimap/sessionthread.cpp	(.../branches/KDE/4.5/kdepimlibs)	(wersja 1165574)
@@ -118,16 +118,12 @@
 
 void SessionThread::closeSocket()
 {
-  QMutexLocker locker(&m_mutex);
-
-  m_encryptedMode = false;
   QTimer::singleShot( 0, this, SLOT( doCloseSocket() ) );
 }
 
 void SessionThread::doCloseSocket()
 {
-  QMutexLocker locker(&m_mutex);
-
+  m_encryptedMode = false;
   m_socket->close();
 }
 
Index: kmime/kmime_content.cpp
===================================================================
--- kmime/kmime_content.cpp	(.../tags/KDE/4.5.0/kdepimlibs)	(wersja 1165574)
+++ kmime/kmime_content.cpp	(.../branches/KDE/4.5/kdepimlibs)	(wersja 1165574)
@@ -513,6 +513,7 @@
         // Add to new content.
         main->setHeader( *it );
         // Remove from this content.
+        delete (*it);
         it = h_eaders.erase( it );
       } else {
         ++it;
@@ -575,6 +576,7 @@
     foreach( Headers::Base *h, main->h_eaders ) {
       setHeader( h ); // Will remove the old one if present.
     }
+    qDeleteAll( main->h_eaders );
     main->h_eaders.clear();
 
     // Move the body.
Index: kcal/incidenceformatter.cpp
===================================================================
--- kcal/incidenceformatter.cpp	(.../tags/KDE/4.5.0/kdepimlibs)	(wersja 1165574)
+++ kcal/incidenceformatter.cpp	(.../branches/KDE/4.5/kdepimlibs)	(wersja 1165574)
@@ -351,7 +351,11 @@
       if ( (*it)->uri().startsWith( QLatin1String( "kmail:" ) ) ) {
         name = i18n( "Show mail" );
       } else {
-        name = (*it)->label();
+        if ( (*it)->label().isEmpty() ) {
+          name = (*it)->uri();
+        } else {
+          name = (*it)->label();
+        }
       }
       tmpStr += htmlAddLink( (*it)->uri(), name );
     } else {
@@ -395,7 +399,6 @@
   //TODO: add a birthday cake icon
   QString tmpStr = displayViewLinkPerson( email_1, name_1, uid_1, iconPath );
 
-
   return tmpStr;
 }
 
@@ -578,7 +581,7 @@
   const bool isBirthday = event->customProperty( "KABC", "BIRTHDAY" ) == "YES";
   const bool isAnniversary = event->customProperty( "KABC", "ANNIVERSARY" ) == "YES";
 
-  if ( isBirthday || isAnniversary  ) {
+  if ( isBirthday || isAnniversary ) {
     tmpStr += "<tr>";
     if ( isAnniversary ) {
       tmpStr += "<td><b>" + i18n( "Anniversary:" ) + "</b></td>";
Index: akonadi/entitymimetypefiltermodel.cpp
===================================================================
--- akonadi/entitymimetypefiltermodel.cpp	(.../tags/KDE/4.5.0/kdepimlibs)	(wersja 1165574)
+++ akonadi/entitymimetypefiltermodel.cpp	(.../branches/KDE/4.5/kdepimlibs)	(wersja 1165574)
@@ -214,6 +214,13 @@
   if (!sourceModel())
     return false;
 
+  // QSortFilterProxyModel implementation is buggy in that it emits rowsAboutToBeInserted etc
+  // only after the source model has emitted rowsInserted, instead of emitting it when the
+  // source model emits rowsAboutToBeInserted. That means that the source and the proxy are out
+  // of sync around the time of insertions, so we can't use the optimization below.
+  return rowCount(parent) > 0;
+#if 0
+
   if ( !parent.isValid() )
     return sourceModel()->hasChildren(parent);
 
@@ -233,6 +240,7 @@
     }
   }
   return false;
+#endif
 }
 
 bool EntityMimeTypeFilterModel::canFetchMore( const QModelIndex &parent ) const
Index: akonadi/itemsync.cpp
===================================================================
--- akonadi/itemsync.cpp	(.../tags/KDE/4.5.0/kdepimlibs)	(wersja 1165574)
+++ akonadi/itemsync.cpp	(.../branches/KDE/4.5/kdepimlibs)	(wersja 1165574)
@@ -53,7 +53,8 @@
       mStreaming( false ),
       mIncremental( false ),
       mLocalListDone( false ),
-      mDeliveryDone( false )
+      mDeliveryDone( false ),
+      mFinished( false )
     {
       // we want to fetch all data by default
       mFetchScope.fetchFullPayload();
@@ -106,6 +107,7 @@
     bool mIncremental;
     bool mLocalListDone;
     bool mDeliveryDone;
+    bool mFinished;
 };
 
 void ItemSync::Private::createLocalItem( const Item & item )
@@ -124,7 +126,10 @@
   if ( mPendingJobs > 0 || !mDeliveryDone || mTransactionJobs > 0 )
     return;
 
-  q->emitResult();
+  if ( !mFinished ) { // prevent double result emission, can happen since checkDone() is called from all over the place
+    mFinished = true;
+    q->emitResult();
+  }
 }
 
 ItemSync::ItemSync( const Collection &collection, QObject *parent ) :
Index: akonadi/session.cpp
===================================================================
--- akonadi/session.cpp	(.../tags/KDE/4.5.0/kdepimlibs)	(wersja 1165574)
+++ akonadi/session.cpp	(.../branches/KDE/4.5/kdepimlibs)	(wersja 1165574)
@@ -164,7 +164,6 @@
   if ( currentJob )
     currentJob->d_ptr->lostConnection();
   connected = false;
-  QTimer::singleShot( 30000, mParent, SLOT( reconnect() ) );
 }
 
 void SessionPrivate::dataReceived()
Index: akonadi/transactionsequence.cpp
===================================================================
--- akonadi/transactionsequence.cpp	(.../tags/KDE/4.5.0/kdepimlibs)	(wersja 1165574)
+++ akonadi/transactionsequence.cpp	(.../branches/KDE/4.5/kdepimlibs)	(wersja 1165574)
@@ -104,7 +104,7 @@
     else
       Job::removeSubjob( job );
 
-    if ( subjobs().isEmpty() && d->mState == TransactionSequencePrivate::WaitingForSubjobs ) {
+    if ( !hasSubjobs() && d->mState == TransactionSequencePrivate::WaitingForSubjobs ) {
       d->mState = TransactionSequencePrivate::Committing;
       TransactionCommitJob *job = new TransactionCommitJob( this );
       connect( job, SIGNAL( result( KJob* ) ), SLOT( commitResult( KJob* ) ) );
@@ -113,7 +113,14 @@
     setError( job->error() );
     setErrorText( job->errorText() );
     removeSubjob( job );
+
+    // cancel all subjobs in case someone else is listening (such as ItemSync), but without notifying ourselves again
+    foreach ( KJob* job, subjobs() ) {
+      disconnect( job, SIGNAL(result(KJob*)), this, SLOT(slotResult(KJob*)) );
+      job->kill( EmitResult );
+    }
     clearSubjobs();
+
     if ( d->mState == TransactionSequencePrivate::Running || d->mState == TransactionSequencePrivate::WaitingForSubjobs ) {
       d->mState = TransactionSequencePrivate::RollingBack;
       TransactionRollbackJob *job = new TransactionRollbackJob( this );
Index: akonadi/kdescendantsproxymodel.cpp
===================================================================
--- akonadi/kdescendantsproxymodel.cpp	(.../tags/KDE/4.5.0/kdepimlibs)	(wersja 1165574)
+++ akonadi/kdescendantsproxymodel.cpp	(.../branches/KDE/4.5/kdepimlibs)	(wersja 1165574)
@@ -171,7 +171,10 @@
       Q_ASSERT(child.isValid());
 
       if (q->sourceModel()->hasChildren(child))
+      {
+        Q_ASSERT(q->sourceModel()->rowCount(child) > 0);
         newPendingParents.append(child);
+      }
     }
   }
   m_pendingParents += newPendingParents;
@@ -335,6 +338,7 @@
 
   if (d->m_mapping.isEmpty() && sourceModel()->hasChildren())
   {
+    Q_ASSERT(sourceModel()->rowCount() > 0);
     const_cast<KDescendantsProxyModelPrivate*>(d)->synchronousMappingRefresh();
   }
   return d->m_rowCount;
@@ -538,6 +542,7 @@
 
   if (!q->sourceModel()->hasChildren(parent))
   {
+    Q_ASSERT(q->sourceModel()->rowCount(parent) == 0);
     // parent was not a parent before.
     return;
   }
@@ -559,6 +564,7 @@
     QModelIndex idx = q->sourceModel()->index(rowCount - 1, column, parent);
     while (q->sourceModel()->hasChildren(idx))
     {
+      Q_ASSERT(q->sourceModel()->rowCount(idx) > 0);
       idx = q->sourceModel()->index(q->sourceModel()->rowCount(idx) - 1, column, idx);
     }
     // The last item in the list is getting a sibling below it.
@@ -648,13 +654,16 @@
     const QModelIndex idx = q->sourceModel()->index(row, column, parent);
     Q_ASSERT(idx.isValid());
     if (q->sourceModel()->hasChildren(idx))
+    {
+      Q_ASSERT(q->sourceModel()->rowCount(idx) > 0);
       m_pendingParents.append(idx);
+    }
   }
 
   m_rowCount += difference;
 
+  q->endInsertRows();
   scheduleProcessPendingParents();
-  q->endInsertRows();
 }
 
 void KDescendantsProxyModelPrivate::sourceRowsAboutToBeRemoved(const QModelIndex &parent, int start, int end)
@@ -667,6 +676,7 @@
   QModelIndex idx = q->sourceModel()->index(end, column, parent);
   while (q->sourceModel()->hasChildren(idx))
   {
+    Q_ASSERT(q->sourceModel()->rowCount(idx) > 0);
     idx = q->sourceModel()->index(q->sourceModel()->rowCount(idx) - 1, column, idx);
   }
   const int proxyEnd = q->mapFromSource(idx).row();
@@ -751,6 +761,7 @@
   resetInternalData();
   if (q->sourceModel()->hasChildren())
   {
+    Q_ASSERT(q->sourceModel()->rowCount() > 0);
     m_pendingParents.append(QModelIndex());
     scheduleProcessPendingParents();
   }
Index: akonadi/tests/itemsynctest.cpp
===================================================================
--- akonadi/tests/itemsynctest.cpp	(.../tags/KDE/4.5.0/kdepimlibs)	(wersja 1165574)
+++ akonadi/tests/itemsynctest.cpp	(.../branches/KDE/4.5/kdepimlibs)	(wersja 1165574)
@@ -97,9 +97,10 @@
         Item::List l;
         l << origItems[i];
         syncer->setFullSyncItems( l );
-        if ( i < origItems.count() - 1 )
+        if ( i < origItems.count() - 1 ) {
           QTest::qWait( 10 ); // enter the event loop so itemsync actually can do something
-        QCOMPARE( spy.count(), 0 );
+          QCOMPARE( spy.count(), 0 );
+        }
       }
       QTest::qWait( 1000 ); // let it finish its job
       QCOMPARE( spy.count(), 1 );
Index: akonadi/contact/editor/im/protocols/ircprotocol.desktop
===================================================================
--- akonadi/contact/editor/im/protocols/ircprotocol.desktop	(.../tags/KDE/4.5.0/kdepimlibs)	(wersja 1165574)
+++ akonadi/contact/editor/im/protocols/ircprotocol.desktop	(.../branches/KDE/4.5/kdepimlibs)	(wersja 1165574)
@@ -11,6 +11,7 @@
 Comment[de]=Internet Relay Chat
 Comment[en_GB]=Internet Relay Chat
 Comment[eo]=Interreta plusenda babilado
+Comment[es]=Internet Relay Chat
 Comment[et]=Rühmadiskussioon internetis
 Comment[fr]=Relai Internet de discussion
 Comment[ga]=Internet Relay Chat
Index: akonadi/contact/editor/im/protocols/groupwiseprotocol.desktop
===================================================================
--- akonadi/contact/editor/im/protocols/groupwiseprotocol.desktop	(.../tags/KDE/4.5.0/kdepimlibs)	(wersja 1165574)
+++ akonadi/contact/editor/im/protocols/groupwiseprotocol.desktop	(.../branches/KDE/4.5/kdepimlibs)	(wersja 1165574)
@@ -11,6 +11,7 @@
 Comment[de]=Novell-GroupWise-Nachrichtendienst
 Comment[en_GB]=Novell GroupWise Messenger
 Comment[eo]=Novell GroupWise mesaĝilo
+Comment[es]=Mensajería de Novell GroupWise
 Comment[et]=Novell GroupWise Messenger
 Comment[fr]=Messagerie GroupWise Novell
 Comment[ga]=Teachtaire Novell GroupWise
@@ -41,6 +42,7 @@
 Name[de]=GroupWise
 Name[en_GB]=GroupWise
 Name[eo]=GroupWise
+Name[es]=GroupWise
 Name[et]=GroupWise
 Name[fr]=GroupWise
 Name[ga]=GroupWise

Zmiany atrybutów dla: .
___________________________________________________________________
Zmienione: svnmerge-integrated
   - /branches/work/akonadi-ports/kdepimlibs:1-982692,983264,983691-986698,986700-987562,987564-994694,994696-994808,994810-994820,994822-995232,995234-995396,995398-995404,995406-995798,995800-997744,997746-1006186,1006188-1006193,1006196-1007211,1007213,1007215-1007217,1007219-1007231,1007233-1010098,1010100-1012993,1012995-1013019,1013021-1023684,1029746-1029748,1030617-1030629,1031955-1073464,1073635-1073636,1074770 /branches/kdepim/enterprise4/kdepimlibs:1-809779,809854-813579,813581-813598,813600-821927,822131,823512,823589,824206,824213,824895,831358,834955-835617,837809,843671,844028,844044,850305,852197,853294,853770,854349,854627,856353,856699,856996,859216,861651,861668,863904-863910,874469,875493,877777,881490,883237,883308,883317,883319,883322,883324,883327,900447,915152-915164,918707,921740,931414,931427,937851,937906-938266,938268-938271,938273-938278,938281-940157,941295,944957,947276,948737,950530,951162,961006-961007,961567,962326,962328,965363,967747,969620,970460-970465,970468,974183,977548-979665,979667-980927,980929-982939,982941-982947,982949-982950,982953-982954,982956-983182,983184-983186,983188-986158,986160-989638,989925-990097,990099-990113,992544,993922,994464,994512,999727,999889,1001119,1001354,1001591,1001919,1003652,1003683,1004162,1004200-1004627,1006338,1006407,1006811,1007376,1008464,1009689,1009786,1010097,1010408,1010804,1010837,1012351,1012416,1012629,1013745-1013757,1015161,1015463,1020958,1022132,1022145,1022367,1023349,1023454,1023981,1026836,1029015,1038909-1038911,1040719,1040870,1041824,1042271,1042721,1042766,1047215,1055387,1057460,1058343,1058473,1060332,1062466,1063997,1065143,1066072-1066387,1066389-1067091,1067813,1067894,1067916,1071151,1071166,1072577,1073312,1090463,1090554,1090577,1102530-1102531 /trunk/KDE/kdepimlibs:1-1143426
   + /branches/kdepim/enterprise4/kdepimlibs:1-809779,809854-813579,813581-813598,813600-821927,822131,823512,823589,824206,824213,824895,831358,834955-835617,837809,843671,844028,844044,850305,852197,853294,853770,854349,854627,856353,856699,856996,859216,861651,861668,863904-863910,874469,875493,877777,881490,883237,883308,883317,883319,883322,883324,883327,900447,915152-915164,918707,921740,931414,931427,937851,937906-938266,938268-938271,938273-938278,938281-940157,941295,944957,947276,948737,950530,951162,961006-961007,961567,962326,962328,965363,967747,969620,970460-970465,970468,974183,977548-979665,979667-980927,980929-982939,982941-982947,982949-982950,982953-982954,982956-983182,983184-983186,983188-986158,986160-989638,989925-990097,990099-990113,992544,993922,994464,994512,999727,999889,1001119,1001354,1001591,1001919,1003652,1003683,1004162,1004200-1004627,1006338,1006407,1006811,1007376,1008464,1009689,1009786,1010097,1010408,1010804,1010837,1012351,1012416,1012629,1013745-1013757,1015161,1015463,1020958,1022132,1022145,1022367,1023349,1023454,1023981,1026836,1029015,1038909-1038911,1040719,1040870,1041824,1042271,1042721,1042766,1047215,1055387,1057460,1058343,1058473,1060332,1062466,1063997,1065143,1066072-1066387,1066389-1067091,1067813,1067894,1067916,1071151,1071166,1072577,1073312,1090463,1090554,1090577,1102530-1102531 /branches/work/akonadi-ports/kdepimlibs:1-982692,983264,983691-986698,986700-987562,987564-994694,994696-994808,994810-994820,994822-995232,995234-995396,995398-995404,995406-995798,995800-997744,997746-1006186,1006188-1006193,1006196-1007211,1007213,1007215-1007217,1007219-1007231,1007233-1010098,1010100-1012993,1012995-1013019,1013021-1023684,1029746-1029748,1030617-1030629,1031955-1073464,1073635-1073636,1074770 /trunk/KDE/kdepimlibs:1-1143426,1149395,1154892,1161656,1163117

